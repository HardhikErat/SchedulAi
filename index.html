<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SchedulAi - Firebase Edition (with Admin)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .fade-in { animation: fadeIn 0.35s ease-in; }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Splash -->
  <div id="splashScreen" class="fixed inset-0 bg-indigo-600 flex items-center justify-center z-50 text-white">
    <div class="text-center">
      <h1 class="text-4xl font-bold">SchedulAi</h1>
      <p class="mt-2">Initializing...</p>
    </div>
  </div>

  <!-- Role Selection -->
  <div id="roleSelection" class="min-h-screen hidden flex items-center justify-center p-6">
    <div class="bg-white rounded-xl p-8 w-full max-w-2xl text-center">
      <h2 class="text-2xl font-semibold mb-4">Welcome to SchedulAi</h2>
      <p class="text-sm text-gray-600 mb-6">Choose your role to continue</p>
      <div class="flex gap-4 justify-center">
        <button onclick="selectRole('student')" class="px-6 py-3 bg-indigo-600 text-white rounded-lg">Student</button>
        <button onclick="selectRole('teacher')" class="px-6 py-3 bg-green-600 text-white rounded-lg">Teacher</button>
        <button onclick="selectRole('admin')" class="px-6 py-3 bg-amber-600 text-white rounded-lg">Admin</button>
      </div>
    </div>
  </div>

  <!-- Login / Signup -->
  <div id="loginScreen" class="hidden min-h-screen flex items-start justify-center p-10">
    <div class="w-full max-w-md bg-white rounded-xl p-6 shadow">
      <h2 id="loginTitle" class="text-xl font-semibold mb-3">Login</h2>

      <form id="loginForm" class="space-y-3">
        <input id="loginEmail" type="email" placeholder="Email" required class="w-full px-3 py-2 border rounded"/>
        <input id="loginPassword" type="password" placeholder="Password" required class="w-full px-3 py-2 border rounded"/>
        <button class="w-full bg-indigo-600 text-white py-2 rounded">Sign In</button>
      </form>

      <!-- Signup form -->
      <form id="signupForm" class="space-y-3 hidden mt-4">
        <div class="grid grid-cols-2 gap-2">
          <input id="firstName" placeholder="First name" required class="px-3 py-2 border rounded"/>
          <input id="lastName" placeholder="Last name" required class="px-3 py-2 border rounded"/>
        </div>
        <input id="signupEmail" type="email" placeholder="Email" required class="w-full px-3 py-2 border rounded"/>
        <input id="mobile" placeholder="Mobile" class="w-full px-3 py-2 border rounded"/>
        <input id="userId" placeholder="Student/Employee ID" class="w-full px-3 py-2 border rounded"/>

        <!-- Student-only fields -->
        <div id="studentFields" class="hidden">
          <select id="signupDept" class="w-full px-3 py-2 border rounded">
            <option value="">Select Department</option>
          </select>
          <select id="signupClass" class="w-full px-3 py-2 border rounded">
            <option value="">Select Class</option>
          </select>
        </div>

        <input id="signupPassword" type="password" placeholder="Password" required class="w-full px-3 py-2 border rounded"/>
        <p id="passwordHint" class="text-xs mt-1 text-gray-500">Password must be at least 8 characters, include letters and numbers</p>
        <input id="confirmPassword" type="password" placeholder="Confirm password" required class="w-full px-3 py-2 border rounded"/>
        <button class="w-full bg-green-600 text-white py-2 rounded">Create Account</button>
        <p class="text-xs text-gray-500">Note: Admin login is restricted to a single admin configured in Firestore settings.</p>
      </form>

      <div class="mt-4 text-center">
        <button id="toggleAuth" onclick="toggleAuthMode()" class="text-indigo-600">Don't have an account? Sign up</button>
      </div>
      <div class="mt-3 text-center">
        <button onclick="showRoleSelection()" class="text-sm text-gray-600">← Back to role selection</button>
      </div>
    </div>
  </div>

  <!-- Student Dashboard -->
  <main id="studentDashboard" class="hidden min-h-screen p-8">
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-semibold">SchedulAi — Student</h1>
      <div class="flex items-center gap-3">
        <div>Welcome, <strong id="studentName">Student</strong></div>
        <button onclick="logout()" class="px-3 py-1 rounded bg-gray-200">Logout</button>
      </div>
    </header>
    <section>
      <h2 class="text-lg font-semibold mb-3">My Timetable</h2>
      <div class="bg-white rounded shadow overflow-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="p-3">Time</th>
              <th class="p-3">Monday</th>
              <th class="p-3">Tuesday</th>
              <th class="p-3">Wednesday</th>
              <th class="p-3">Thursday</th>
              <th class="p-3">Friday</th>
            </tr>
          </thead>
          <tbody id="studentTimetable" class="divide-y"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Teacher Dashboard -->
  <main id="teacherDashboard" class="hidden min-h-screen p-8">
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-semibold">SchedulAi — Teacher</h1>
      <div class="flex items-center gap-3">
        <div>Welcome, <strong id="teacherName">Teacher</strong></div>
        <button onclick="logout()" class="px-3 py-1 rounded bg-gray-200">Logout</button>
      </div>
    </header>

    <!-- Add lecture form -->
    <form id="addLectureForm" class="grid grid-cols-6 gap-2 bg-white p-4 rounded shadow mb-6">
      <select id="subjectSelect" class="col-span-2 p-2 border rounded" required>
        <option value="">Select Subject</option>
      </select>
      <select id="classSelect" class="p-2 border rounded" required>
        <option value="">Select Class</option>
      </select>
      <select id="classroomSelect" class="p-2 border rounded" required>
        <option value="">Select Room</option>
      </select>
      <select id="daySelect" class="p-2 border rounded" required>
        <option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option>
      </select>
      <select id="timeSelect" class="p-2 border rounded" required>
        <option>09:00-10:00</option>
        <option>10:00-11:00</option>
        <option>11:00-12:00</option>
        <option>12:00-13:00</option>
        <option>13:00-14:00</option>
        <option>14:00-15:00</option>
        <option>15:00-16:00</option>
        <option>16:00-17:00</option>
      </select>
      <button class="col-span-6 bg-green-600 text-white py-2 rounded">Add Lecture</button>
    </form>

    <!-- Timetable -->
    <div class="bg-white rounded shadow overflow-auto mb-6">
      <table class="w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="p-3">Time</th>
            <th class="p-3">Monday</th>
            <th class="p-3">Tuesday</th>
            <th class="p-3">Wednesday</th>
            <th class="p-3">Thursday</th>
            <th class="p-3">Friday</th>
          </tr>
        </thead>
        <tbody id="teacherTimetable" class="divide-y"></tbody>
      </table>
    </div>
  </main>

  <!-- Admin Dashboard -->
  <main id="adminDashboard" class="hidden min-h-screen p-8">
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-semibold">SchedulAi — Admin</h1>
      <div class="flex items-center gap-3">
        <div>Welcome, <strong id="adminName">Admin</strong></div>
        <button onclick="logout()" class="px-3 py-1 rounded bg-gray-200">Logout</button>
      </div>
    </header>

    <!-- Management Panel -->
    <section class="bg-white p-4 rounded shadow">
      <h3 class="text-lg font-semibold mb-4">Management Panel</h3>
      <div class="grid grid-cols-2 gap-6">
        <div>
          <h4 class="font-medium mb-2">Departments</h4>
          <form id="addDepartmentForm" class="flex gap-2 mb-2">
            <input id="departmentName" placeholder="Department" class="flex-1 p-2 border rounded" required />
            <button class="px-3 bg-indigo-600 text-white rounded">Add</button>
          </form>
          <ul id="departmentsList" class="pl-4 text-sm text-gray-700"></ul>
        </div>

        <div>
          <h4 class="font-medium mb-2">Classes</h4>
          <form id="addClassForm" class="flex gap-2 mb-2">
            <input id="className" placeholder="Class (e.g. CS-A)" class="flex-1 p-2 border rounded" required />
            <select id="classDept" class="p-2 border rounded">
              <option value="">-- Dept --</option>
            </select>
            <button class="px-3 bg-indigo-600 text-white rounded">Add</button>
          </form>
          <ul id="classesList" class="pl-4 text-sm text-gray-700"></ul>
        </div>

        <div>
          <h4 class="font-medium mb-2">Subjects</h4>
          <form id="addSubjectForm" class="flex gap-2 mb-2">
            <input id="subjectName" placeholder="Subject" class="flex-1 p-2 border rounded" required />
            <select id="subjectDept" class="p-2 border rounded">
              <option value="">-- Dept --</option>
            </select>
            <button class="px-3 bg-indigo-600 text-white rounded">Add</button>
          </form>
          <ul id="subjectsList" class="pl-4 text-sm text-gray-700"></ul>
        </div>

        <div>
          <h4 class="font-medium mb-2">Classrooms</h4>
          <form id="addClassroomForm" class="flex gap-2 mb-2">
            <input id="classroomName" placeholder="Room (e.g. A101)" class="flex-1 p-2 border rounded" required />
            <input id="classroomCapacity" type="number" placeholder="Capacity" class="w-24 p-2 border rounded" />
            <button class="px-3 bg-indigo-600 text-white rounded">Add</button>
          </form>
          <ul id="classroomsList" class="pl-4 text-sm text-gray-700"></ul>
        </div>
      </div>

      <!-- Lunch Break Setting -->
      <div class="mt-8">
        <h4 class="font-medium mb-2">Lunch Break</h4>
        <form id="lunchBreakForm" class="flex gap-2 mb-2">
          <select id="lunchBreakSlot" class="p-2 border rounded">
            <option value="">-- Select Slot --</option>
            <option>09:00-10:00</option>
            <option>10:00-11:00</option>
            <option>11:00-12:00</option>
            <option>12:00-13:00</option>
            <option>13:00-14:00</option>
            <option>14:00-15:00</option>
            <option>15:00-16:00</option>
            <option>16:00-17:00</option>
          </select>
          <button class="px-3 bg-indigo-600 text-white rounded">Save</button>
        </form>
        <p class="text-sm text-gray-600">Current Lunch Break: <span id="currentLunchBreak">None</span></p>
      </div>
    </section>
  </main>

  <div id="messageContainer" class="fixed bottom-4 right-4 space-y-2"></div>

  <!-- Firebase + App JS -->
  <script type="module">
    // ===== Firebase =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { onSnapshot, getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCNTq71D6ZxNCl6uBw9Tmenn1WeMTJW0S4",
      authDomain: "schedulai-3a966.firebaseapp.com",
      projectId: "schedulai-3a966",
      storageBucket: "schedulai-3a966.firebasestorage.app",
      messagingSenderId: "251377613051",
      appId: "1:251377613051:web:59ffeffa19cfa428a4585e",
      measurementId: "G-4PC85M192H"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const fdb = getFirestore(app);

    // ===== DOM Utils =====
    const $  = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove("hidden");
    const hide = (el) => el.classList.add("hidden");

    // ===== Global State =====
    let currentUser = null;
    let currentRole = null;
    let lunchBreakSlot = null;

    // ===== Constants =====
    const SLOT_TIMES = [
      "09:00-10:00","10:00-11:00","11:00-12:00","12:00-13:00",
      "13:00-14:00","14:00-15:00","15:00-16:00","16:00-17:00"
    ];
    const WEEK_DAYS = ["Monday","Tuesday","Wednesday","Thursday","Friday"];

    // ===== Messages =====
    const showMessage = (msg, type="success") => {
      const d = document.createElement("div");
      d.className = `p-3 rounded shadow ${type==="error"?"bg-red-100 text-red-700":"bg-green-100 text-green-700"} fade-in`;
      d.textContent = msg;
      $("messageContainer").appendChild(d);
      setTimeout(()=>d.remove(),3000);
    };

    // ===== Views =====
    function switchView(view) {
      const views = ["roleSelection","loginScreen","studentDashboard","teacherDashboard","adminDashboard","splashScreen"];
      views.forEach(v => hide($(v)));
      show($(view));
    }

    // ===== Role Selection =====
    window.selectRole = (role) => {
      currentRole = role;
      switchView("loginScreen");
      $("loginTitle").textContent = role.charAt(0).toUpperCase()+role.slice(1)+" Login";
      // student fields only if student selected
      $("studentFields").classList.toggle("hidden", role !== "student");
    };
    window.showRoleSelection = () => {
      currentRole = null;
      switchView("roleSelection");
    };

    // ===== Auth Mode Toggle =====
    let isLoginMode = true;
    window.toggleAuthMode = ()=>{
      isLoginMode = !isLoginMode;
      $("loginForm").classList.toggle("hidden", !isLoginMode);
      $("signupForm").classList.toggle("hidden", isLoginMode);
      $("toggleAuth").textContent = isLoginMode ? "Don't have an account? Sign up" : "Already have an account? Sign in";
      if (!isLoginMode && currentRole === "student") populateSignupDropdowns();
    };

    // ===== Populate Signup Dropdowns (student only) =====
    async function populateSignupDropdowns(){
      try {
        // Departments
        const deptSnap = await getDocs(collection(fdb,"departments"));
        const deptSelect = $("signupDept");
        deptSelect.innerHTML = '<option value="">Select Department</option>';
        deptSnap.forEach(d=>{
          const opt=document.createElement("option");
          opt.value=d.data().name; opt.textContent=d.data().name;
          deptSelect.appendChild(opt);
        });
        // Classes
        const classSnap = await getDocs(collection(fdb,"classes"));
        const classSelect = $("signupClass");
        classSelect.innerHTML = '<option value="">Select Class</option>';
        classSnap.forEach(c=>{
          const data=c.data();
          const opt=document.createElement("option");
          opt.value=data.name; opt.textContent=`${data.name} (${data.department||"No Dept"})`;
          classSelect.appendChild(opt);
        });
      } catch (e) {
        console.error(e);
      }
    }

    // ===== Password Strength Indicator =====
    const signupPasswordEl = $("signupPassword");
    const passwordHint = $("passwordHint");
    signupPasswordEl.addEventListener("input", () => {
      const pass = signupPasswordEl.value;
      const regex = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/;
      if (!pass) {
        passwordHint.textContent = "Password must be at least 8 characters, include letters and numbers";
        passwordHint.className = "text-xs mt-1 text-gray-500";
      } else if (regex.test(pass)) {
        passwordHint.textContent = "Strong password ✔";
        passwordHint.className = "text-xs mt-1 text-green-600";
      } else {
        passwordHint.textContent = "Weak password ✘ (must be ≥8 chars, include letters and numbers)";
        passwordHint.className = "text-xs mt-1 text-red-600";
      }
    });

    // ===== Signup =====
    $("signupForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const first = $("firstName").value.trim();
      const last = $("lastName").value.trim();
      const email = $("signupEmail").value.trim();
      const mobile = $("mobile").value.trim();
      const userIdVal = $("userId").value.trim();
      const deptVal = (currentRole === "student") ? $("signupDept").value : null;
      const classVal = (currentRole === "student") ? $("signupClass").value : null;
      const pass = $("signupPassword").value;
      const confirm = $("confirmPassword").value;

      if(pass!==confirm){ showMessage("Passwords mismatch","error"); return; }

      const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/;
      if (!passwordRegex.test(pass)) {
        showMessage("Password must be at least 8 characters long and contain letters and numbers","error");
        return;
      }

      if (currentRole === "student" && (!deptVal || !classVal)) {
        showMessage("Please select Department and Class","error");
        return;
      }

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(fdb,"users",cred.user.uid),{
          firstName:first,
          lastName:last,
          email,
          mobile,
          userId:userIdVal,
          role:currentRole,
          department: (currentRole === "student") ? deptVal : null,
          className: (currentRole === "student") ? classVal : null,
          joinDate:new Date().toISOString()
        });
        showMessage("Account created, please login");
        isLoginMode = true; window.toggleAuthMode();
      }catch(err){ console.error(err); showMessage("Signup failed","error"); }
    });

    // ===== Single-Admin Enforcement =====
    async function ensureAdminAccess(credUser){
      // settings/admin document must exist with { uid: "<adminUid>" } OR { email: "<adminEmail>" }
      const adminSnap = await getDoc(doc(fdb,"settings","admin"));
      if (!adminSnap.exists()) {
        showMessage("Admin not configured. Contact system owner.","error");
        return false;
      }
      const cfg = adminSnap.data() || {};
      const uidAllowed = cfg.uid && cfg.uid === credUser.uid;
      const emailAllowed = cfg.email && cfg.email.toLowerCase() === (credUser.email||"").toLowerCase();
      if (uidAllowed || emailAllowed) return true;

      showMessage("This account is not authorized as the admin.","error");
      return false;
    }

    // ===== Login =====
    $("loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email = $("loginEmail").value.trim();
      const pass = $("loginPassword").value;
      try {
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        const profSnap = await getDoc(doc(fdb,"users",cred.user.uid));
        if(!profSnap.exists()){ showMessage("Profile missing","error"); await signOut(auth); return; }
        const data = profSnap.data();

        // Role mismatch check (prevents student logging as teacher etc.)
        if(data.role!==currentRole){
          showMessage(`Wrong role for this account (${data.role})`,"error");
          await signOut(auth);
          return;
        }

        // Single-admin check
        if (currentRole === "admin") {
          const ok = await ensureAdminAccess(cred.user);
          if (!ok) { await signOut(auth); return; }
        }

        currentUser = { id: cred.user.uid, email: cred.user.email, ...data };
        hide($("loginScreen"));

        if(currentRole==="student"){
          show($("studentDashboard"));
          $("studentName").textContent = `${currentUser.firstName} ${currentUser.lastName}`;
          await loadLunchBreak();
          await loadStudentTimetable();
        } else if (currentRole === "teacher") {
          show($("teacherDashboard"));
          $("teacherName").textContent = `${currentUser.firstName} ${currentUser.lastName}`;
          await loadLunchBreak();
          await populateTeacherSelects();
          await loadTeacherTimetable();
        } else if (currentRole === "admin") {
          show($("adminDashboard"));
          $("adminName").textContent = `${currentUser.firstName} ${currentUser.lastName}`;
          await initManagementPanel();
        }

        showMessage("Login successful");
      }catch(err){ console.error(err); showMessage("Login failed","error"); }
    });

    // ===== Logout =====
    window.logout = async ()=>{
      try { await signOut(auth); } catch(_) {}
      currentUser=null; currentRole=null;
      ["studentDashboard","teacherDashboard","adminDashboard"].forEach(id=>hide($(id)));
      show($("roleSelection"));
    };

    // ===== Generic Helpers for Lists & Selects =====
    async function fetchAll(coll) {
      const snap = await getDocs(collection(fdb, coll));
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    function fillSelect(selectEl, items, getText, getValue=getText, firstOption="-- Select --") {
      if (!selectEl) return;
      const opts = [`<option value="">${firstOption}</option>`]
        .concat(items.map(it => `<option value="${getValue(it)}">${getText(it)}</option>`));
      selectEl.innerHTML = opts.join("");
    }

    function renderList(listEl, items, formatRowHTML, onDelete) {
      if (!listEl) return;
      listEl.innerHTML = "";
      items.forEach(it => {
        const li = document.createElement("li");
        li.className = "flex justify-between items-center";
        li.innerHTML = formatRowHTML(it);
        listEl.appendChild(li);
      });
      // bind delete buttons
      listEl.querySelectorAll("[data-delete-id]").forEach(btn=>{
        btn.onclick = async () => {
          await onDelete(btn.getAttribute("data-delete-id"));
        };
      });
    }

    // ===== Management Panel (CRUD) =====
    async function renderDepartments(){
      const items = await fetchAll("departments");
      renderList($("departmentsList"), items, (d) =>
        `<span>${d.name}</span>
         <button data-delete-id="${d.id}" class="delete-dept bg-red-500 text-white px-2 py-0.5 text-xs rounded">Delete</button>`,
        async (id) => { await deleteDoc(doc(fdb,"departments",id)); showMessage("Department deleted"); renderDepartments(); renderSubjects(); renderClasses(); }
      );
      fillSelect($("classDept"), items, d=>d.name, d=>d.name, "-- Dept --");
      fillSelect($("subjectDept"), items, d=>d.name, d=>d.name, "-- Dept --");
    }

    async function renderClasses(){
      const items = await fetchAll("classes");
      renderList($("classesList"), items, (c) =>
        `<span>${c.name} (${c.department||"No Dept"})</span>
         <button data-delete-id="${c.id}" class="delete-class bg-red-500 text-white px-2 py-0.5 text-xs rounded">Delete</button>`,
        async (id) => { await deleteDoc(doc(fdb,"classes",id)); showMessage("Class deleted"); renderClasses(); }
      );
    }

    async function renderSubjects(){
      const items = await fetchAll("subjects");
      renderList($("subjectsList"), items, (s) =>
        `<span>${s.name} (${s.department||"No Dept"})</span>
         <button data-delete-id="${s.id}" class="delete-subj bg-red-500 text-white px-2 py-0.5 text-xs rounded">Delete</button>`,
        async (id) => { await deleteDoc(doc(fdb,"subjects",id)); showMessage("Subject deleted"); renderSubjects(); }
      );
    }

    async function renderClassrooms(){
      const items = await fetchAll("classrooms");
      renderList($("classroomsList"), items, (r) =>
        `<span>${r.name} (${r.capacity||'N/A'})</span>
         <button data-delete-id="${r.id}" class="delete-room bg-red-500 text-white px-2 py-0.5 text-xs rounded">Delete</button>`,
        async (id) => { await deleteDoc(doc(fdb,"classrooms",id)); showMessage("Classroom deleted"); renderClassrooms(); }
      );
    }

    async function initManagementPanel(){
      await Promise.all([renderDepartments(), renderClasses(), renderSubjects(), renderClassrooms()]);
      await loadLunchBreak();
    }

    // Add Department
    $("addDepartmentForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const name = $("departmentName").value.trim();
      if(!name) return;
      await addDoc(collection(fdb,"departments"),{ name });
      $("departmentName").value = "";
      showMessage("Department added");
      renderDepartments();
    });

    // Add Class
    $("addClassForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const name = $("className").value.trim();
      const dept = $("classDept").value || null;
      if(!name) return;
      await addDoc(collection(fdb,"classes"),{ name, department: dept });
      $("className").value = "";
      showMessage("Class added");
      renderClasses();
    });

    // Add Subject
    $("addSubjectForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const name = $("subjectName").value.trim();
      const dept = $("subjectDept").value || null;
      if(!name) return;
      await addDoc(collection(fdb,"subjects"),{ name, department: dept });
      $("subjectName").value = "";
      showMessage("Subject added");
      renderSubjects();
    });

    // Add Classroom
    $("addClassroomForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const name = $("classroomName").value.trim();
      const capacity = Number($("classroomCapacity").value || 0) || null;
      if(!name) return;
      await addDoc(collection(fdb,"classrooms"),{ name, capacity });
      $("classroomName").value = "";
      $("classroomCapacity").value = "";
      showMessage("Classroom added");
      renderClassrooms();
    });

    // ===== Lunch Break =====
    async function loadLunchBreak(){
      const snap = await getDoc(doc(fdb,"settings","lunchBreak"));
      lunchBreakSlot = snap.exists() ? (snap.data().slot || null) : null;
      const cur = $("currentLunchBreak");
      if (cur) cur.textContent = lunchBreakSlot || "None";
      updateTimeSelectOptions();
      return lunchBreakSlot;
    }

    $("lunchBreakForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const slot = $("lunchBreakSlot").value;
      if(!slot){ showMessage("Select a slot","error"); return; }
      await setDoc(doc(fdb,"settings","lunchBreak"),{ slot });
      lunchBreakSlot = slot;
      const cur = $("currentLunchBreak");
      if (cur) cur.textContent = slot;
      updateTimeSelectOptions();
      showMessage("Lunch break updated");
      if(currentRole==="teacher") await loadTeacherTimetable();
      if(currentRole==="student") await loadStudentTimetable();
    });

    function updateTimeSelectOptions(){
      const sel = $("timeSelect");
      if(!sel) return;
      [...sel.options].forEach(opt=>{
        if(!opt.value) return;
        const val = opt.value || opt.textContent;
        if(lunchBreakSlot && val===lunchBreakSlot){
          opt.disabled = true;
          if(!opt.textContent.includes("(Lunch)")) opt.textContent = `${val} (Lunch)`;
        }else{
          opt.disabled = false;
          opt.textContent = val.replace(" (Lunch)","");
        }
      });
    }

    // ===== Timetables =====
    async function loadStudentTimetable(){
      const tbody = $("studentTimetable");
      if (!tbody || !currentUser) return;
      tbody.innerHTML = '';

      // Get all lectures for the student's class
      const qy = query(collection(fdb,"lectures"), where("className","==", currentUser.className));
      const snap = await getDocs(qy);
      const lectures = snap.docs.map(d=>d.data());

      SLOT_TIMES.forEach(t=>{
        let row = `<tr><td class="p-3 border">${t}</td>`;
        WEEK_DAYS.forEach(d=>{
          if (lunchBreakSlot && t===lunchBreakSlot) {
            row += `<td class="p-3 border bg-yellow-100 text-center font-semibold">Lunch Break</td>`;
          } else {
            const lec = lectures.find(l=>l.day===d && l.time===t);
            row += `<td class="p-3 border">${lec ? `${lec.subject} (${lec.classroom})` : "Free"}</td>`;
          }
        });
        row += `</tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });
    }

    async function loadTeacherTimetable(){
      const tbody = $("teacherTimetable");
      if (!tbody || !currentUser) return;
      tbody.innerHTML = '';

      // Filter first by teacherId with Firestore, then build grid
      const qy = query(collection(fdb,"lectures"), where("teacherId","==", currentUser.id));
      const snap = await getDocs(qy);
      const lectures = snap.docs.map(d=>({id:d.id, ...d.data()}));

      SLOT_TIMES.forEach(t=>{
        let row = `<tr><td class="p-3 border">${t}</td>`;
        WEEK_DAYS.forEach(d=>{
          if (lunchBreakSlot && t===lunchBreakSlot) {
            row += `<td class="p-3 border bg-yellow-100 text-center font-semibold">Lunch Break</td>`;
          } else {
            const lec = lectures.find(l=>l.day===d && l.time===t);
            if(lec){
              row += `<td class="p-3 border">
                        ${lec.subject}<br>
                        <span class='text-xs'>${lec.className||""} ${lec.className?"• ":""}${lec.classroom}</span>
                        <br><button data-id='${lec.id}' class='delete-lecture bg-red-500 text-white text-xs px-2 py-0.5 rounded mt-1'>Delete</button>
                      </td>`;
            } else {
              row += `<td class="p-3 border">Free</td>`;
            }
          }
        });
        row += `</tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });

      // hook delete lecture
      tbody.querySelectorAll(".delete-lecture").forEach(btn=>btn.onclick=async()=>{
        await deleteDoc(doc(fdb,"lectures",btn.dataset.id));
        showMessage("Lecture deleted");
        loadTeacherTimetable();
      });
    }

    // ===== Teacher: populate selects =====
    async function populateTeacherSelects() {
      const [subjects, classes, rooms] = await Promise.all([
        fetchAll("subjects"),
        fetchAll("classes"),
        fetchAll("classrooms")
      ]);
      fillSelect($("subjectSelect"), subjects, s=>s.name);
      fillSelect($("classSelect"), classes, c=>c.name);
      fillSelect($("classroomSelect"), rooms, r=>r.name, r=>r.name, "Select Room");
    }

    // ===== Add Lecture (reduced-conflict query) =====
    $("addLectureForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const subject = $("subjectSelect").value;
      const classNameVal = $("classSelect").value;
      const classroom = $("classroomSelect").value;
      const day = $("daySelect").value;
      const time = $("timeSelect").value;

      if(!subject || !classNameVal || !classroom || !day || !time){ showMessage("Fill all fields","error"); return; }
      if(lunchBreakSlot && time===lunchBreakSlot){ showMessage("Cannot schedule during Lunch Break","error"); return; }

      // Narrow read: only same day, then check conflicts locally
      const sameDaySnap = await getDocs(query(collection(fdb,"lectures"), where("day","==",day)));
      const sameDay = sameDaySnap.docs.map(d=>d.data());
      const conflict = sameDay.find(l =>
        (l.time===time) && (
          l.className===classNameVal ||
          l.classroom===classroom ||
          l.teacherId===currentUser.id
        )
      );
      if(conflict){ showMessage("Conflict detected","error"); return; }

      await addDoc(collection(fdb,"lectures"),{
        subject,
        teacherId:currentUser.id,
        teacherName: `${currentUser.firstName} ${currentUser.lastName}`,
        className: classNameVal,
        classroom,
        day,
        time,
        createdAt: new Date().toISOString()
      });
      showMessage("Lecture added");
      loadTeacherTimetable();
    });

    // ===== Init: splash -> role selection =====
    setTimeout(()=>{
      hide($("splashScreen"));
      show($("roleSelection"));
    },800);
  </script>
</body>
</html>
</html>
